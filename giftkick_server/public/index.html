<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftKick — Mini App (MVP)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --accent: #2dd4bf;
            --muted: #94a3b8;
            --glass: rgba(255,255,255,0.03);
        }
        html, body { margin:0;height:100%;background:linear-gradient(180deg,#071127 0%,#07192b 100%);font-family:Inter,sans-serif;color:#e6eef6; }
        .app { max-width:460px;margin:18px auto;padding:14px; }
        .topbar { display:flex;align-items:center;gap:12px; }
        .logo { width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#1fb6b3,#2dd4bf);display:flex;align-items:center;justify-content:center;font-weight:700;color:#022;box-shadow:0 6px 18px rgba(10,10,20,0.6); }
        .title { flex:1; }
        .title h1 { margin:0;font-size:16px; }
        .title p { margin:0;font-size:12px;color:var(--muted); }
        .balance { background:var(--glass);padding:8px 10px;border-radius:10px;display:flex;flex-direction:column;align-items:flex-end; }
        .balance .val { font-weight:700;color:var(--accent); }
        .tabs { display:flex;gap:8px;margin:14px 0; }
        .tab { flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);text-align:center;cursor:pointer;color:var(--muted); }
        .tab.active { background:linear-gradient(90deg, rgba(45,212,191,0.12), rgba(45,212,191,0.06));color:var(--accent);box-shadow:0 6px 18px rgba(25,45,60,0.5); }
        .card { background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6); }
        .rocket-stage { display:flex;flex-direction:column;align-items:center;gap:10px; }
        .bar { width:100%;height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden; }
        .controls { display:flex;gap:8px;width:100%; }
        .btn { flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#0b2730,#05202a);border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:#dff7f3; }
        .btn.ghost { background:transparent;border:1px dashed rgba(255,255,255,0.04);color:var(--muted); }
        .cases-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px; }
        .case { padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center; }
        .case .price { font-weight:700;color:var(--accent); }
        .case .open { margin-top:8px;padding:8px;border-radius:8px;background:#123241;cursor:pointer; }
        .upgrade-list { display:flex;flex-direction:column;gap:8px;margin-top:10px; }
        .upgrade-item { display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02); }
        .small { font-size:12px;color:var(--muted); }
        footer { margin-top:16px;text-align:center;font-size:12px;color:var(--muted); }
        canvas { width:100%; height:150px; background: rgba(0,0,0,0.1); border-radius:10px; margin-top:10px; }
    </style>
</head>
<body>
<div class="app">
    <div class="topbar">
        <div class="logo">GK</div>
        <div class="title"><h1>GiftKick</h1><p id="userName">Привет, игрок</p></div>
        <div class="balance card"><div class="small">Баланс</div><div class="val" id="balanceVal">1000</div></div>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="rocket">Ракетка</div>
        <div class="tab" data-tab="cases">Кейсы</div>
        <div class="tab" data-tab="upgrade">Апгрейд</div>
    </div>

    <div id="content">
        <div class="card" id="rocketView">
            <div class="rocket-stage">
                <canvas id="rocketChart"></canvas>
                <div class="small" id="rocketStatus">Раунд скоро начнётся</div>
                <div class="controls">
                    <input id="betInput" type="number" min="1" value="10" style="flex:0 0 34%;padding:8px;border-radius:8px;background:#08151b;border:1px solid rgba(255,255,255,0.03);color:#dff7f3"/>
                    <button class="btn" id="betBtn">Ставка</button>
                    <button class="btn ghost" id="cashOutBtn">Забрать</button>
                </div>
            </div>
        </div>

        <div class="card" id="casesView" style="display:none">
            <div class="small">Открой кейс и получи подарок</div>
            <div class="cases-grid">
                <div class="case"><div style="font-weight:700">Starter</div><div class="price">10</div><div class="open" data-cost="10">Открыть</div></div>
                <div class="case"><div style="font-weight:700">Pro</div><div class="price">50</div><div class="open" data-cost="50">Открыть</div></div>
                <div class="case"><div style="font-weight:700">VIP</div><div class="price">200</div><div class="open" data-cost="200">Открыть</div></div>
                <div class="case"><div style="font-weight:700">Legend</div><div class="price">1000</div><div class="open" data-cost="1000">Открыть</div></div>
            </div>
        </div>

        <div class="card" id="upgradeView" style="display:none">
            <div class="small">Апгрейдни подарок: шанс выиграть умножение</div>
            <div class="upgrade-list">
                <div class="upgrade-item">
                    <div><div style="font-weight:700">x2 — 50% шанс</div><div class="small">примерный доход: 2x</div></div>
                    <button class="btn ghost" data-mult="2">Играть</button>
                </div>
                <div class="upgrade-item">
                    <div><div style="font-weight:700">x5 — 20% шанс</div><div class="small">примерный доход: 5x</div></div>
                    <button class="btn ghost" data-mult="5">Играть</button>
                </div>
                <div class="upgrade-item">
                    <div><div style="font-weight:700">x10 — 10% шанс</div><div class="small">примерный доход: 10x</div></div>
                    <button class="btn ghost" data-mult="10">Играть</button>
                </div>
            </div>
        </div>
    </div>
    <footer>GiftKick • MVP</footer>
</div>

<script>
    const userId = 'user123';
    let balance = 1000;
    let rocketInterval, rocketData = [], rocketCrashAt = 0, rocketBet = 0, rocketMultiplier = 1, rocketCashedOut = false;

    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('#content > .card').forEach(c => c.style.display = 'none');
            document.getElementById(tab.dataset.tab + 'View').style.display = 'block';
        });
    });

    function updateBalance(val) { balance = val; document.getElementById('balanceVal').innerText = balance; }

    const canvas = document.getElementById('rocketChart');
    const ctx = canvas.getContext('2d');
    function drawChart() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.moveTo(0, canvas.height);
        rocketData.forEach((v,i)=>{
            const x = i * (canvas.width/100);
            const y = canvas.height - (v/rocketCrashAt)*(canvas.height-20);
            ctx.lineTo(x,y);
        });
        ctx.strokeStyle = '#2dd4bf';
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    document.getElementById('betBtn').addEventListener('click', async () => {
        rocketBet = Number(document.getElementById('betInput').value);
        if (rocketBet <= 0 || rocketBet > balance) return alert('Неверная ставка');
        const res = await fetch('/api/rocket',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,bet:rocketBet})});
        const data = await res.json();
        if(!data.ok) return alert(data.error);
        rocketCrashAt = data.crashAt;
        updateBalance(data.newBalance);
        rocketData = [1];
        rocketMultiplier = 1;
        rocketCashedOut = false;
        document.getElementById('rocketStatus').innerText = 'Ракета взлетает!';

        clearInterval(rocketInterval);
        rocketInterval = setInterval(()=>{
            rocketMultiplier *= 1.015; // ускорение +50%
            rocketData.push(rocketMultiplier);
            drawChart();
            if(rocketMultiplier >= rocketCrashAt){
                clearInterval(rocketInterval);
                document.getElementById('rocketStatus').innerText = 'Ракета упала! Вы проиграли.';
            }
        },100);
    });

    document.getElementById('cashOutBtn').addEventListener('click', ()=>{
        if(rocketCashedOut || rocketMultiplier >= rocketCrashAt) return;
        const gain = Math.floor(rocketBet * rocketMultiplier);
        balance += gain;
        updateBalance(balance);
        rocketCashedOut = true;
        document.getElementById('rocketStatus').innerText = `Вы забрали: ${gain}`;
    });

    document.querySelectorAll('.case .open').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
            const cost = Number(btn.dataset.cost);
            const res = await fetch('/api/case',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,cost})});
            const data = await res.json();
            if(!data.ok) return alert(data.error);
            updateBalance(data.newBalance);
            alert(`Вы получили: ${data.prize} (выигрыш: ${data.payout})`);
        });
    });

    document.querySelectorAll('.upgrade-item button').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
            const mult = Number(btn.dataset.mult);
            const stake = 10;
            const res = await fetch('/api/upgrade',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,stake,mult})});
            const data = await res.json();
            if(!data.ok) return alert(data.error);
            updateBalance(data.newBalance);
            alert(data.won ? `Вы выиграли ${data.gain}` : 'Неудача, попробуйте снова');
        });
    });
</script>
</body>
</html>
