<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GiftKick — Mini App (MVP)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root{
          --bg:#0f1724; --card:#0b1220; --accent:#2dd4bf; --muted:#94a3b8; --glass: rgba(255,255,255,0.03);
          --success: #10b981; --danger:#ef4444;
          font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }
        html,body{height:100%;margin:0;background:linear-gradient(180deg,#071127 0%, #07192b 100%);color:#e6eef6;}
        .app{max-width:460px;margin:18px auto;padding:14px;}
        .topbar{display:flex;align-items:center;gap:12px}
        .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#1fb6b3,#2dd4bf);display:flex;align-items:center;justify-content:center;font-weight:700;color:#022;box-shadow:0 6px 18px rgba(10,10,20,0.6)}
        .title{flex:1}
        .title h1{margin:0;font-size:16px}
        .title p{margin:0;color:var(--muted);font-size:12px}
        .balance{background:var(--glass);padding:8px 10px;border-radius:10px;display:flex;flex-direction:column;align-items:flex-end}
        .balance .val{font-weight:700;color:var(--accent)}
        .tabs{display:flex;gap:8px;margin:14px 0}
        .tab{flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);text-align:center;cursor:pointer;color:var(--muted)}
        .tab.active{background:linear-gradient(90deg, rgba(45,212,191,0.12), rgba(45,212,191,0.06));color:var(--accent);box-shadow:0 6px 18px rgba(25,45,60,0.5)}
        .card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow: 0 6px 20px rgba(2,6,23,0.6);}
        /* Rocket UI */
        .rocket-stage{display:flex;flex-direction:column;align-items:center;gap:10px}
        .mult{font-size:42px;font-weight:800;color:var(--accent);letter-spacing:0.02em}
        .bar{width:100%;height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
        .bar > .fill{height:100%;width:0%;background:linear-gradient(90deg,#34d399,#2dd4bf);transition:width 0.1s linear}
        .controls{display:flex;gap:8px;width:100%}
        .btn{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#0b2730,#05202a);border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:#dff7f3}
        .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04);color:var(--muted)}
        .btn.warn{background:linear-gradient(180deg,#ea580c,#f97316)}
        /* Cases */
        .cases-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .case{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center}
        .case .price{font-weight:700;color:var(--accent)}
        .case .open{margin-top:8px;padding:8px;border-radius:8px;background:#123241;cursor:pointer}
        /* Upgrade */
        .upgrade-list{display:flex;flex-direction:column;gap:8px}
        .upgrade-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
        .small{font-size:12px;color:var(--muted)}
        footer{margin-top:16px;text-align:center;color:var(--muted);font-size:12px}
        /* modal */
        .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:60}
        .modal.open{display:flex}
        .modal .panel{width:92%;max-width:420px;background:#04121a;border-radius:12px;padding:16px}
    </style>
</head>
<body>
<div class="app">
    <div class="topbar">
        <div class="logo">GK</div>
        <div class="title">
            <h1>GiftKick</h1>
            <p id="userName">Привет, игрок</p>
        </div>
        <div class="balance card">
            <div class="small">Баланс</div>
            <div class="val" id="balanceVal">0.00</div>
        </div>
    </div>

    <div class="tabs" role="tablist">
        <div class="tab active" data-tab="rocket">Ракетка</div>
        <div class="tab" data-tab="cases">Кейсы</div>
        <div class="tab" data-tab="upgrade">Апгрейд</div>
    </div>

    <div id="content">
        <!-- Rocket -->
        <div class="card" id="rocketView">
            <div class="rocket-stage">
                <div class="mult" id="multiplier">x1.00</div>
                <div class="bar"><div class="fill" id="rocketFill"></div></div>
                <div class="small" id="rocketStatus">Раунд скоро начнётся</div>
                <div style="width:100%;" class="controls">
                    <input id="betInput" type="number" min="1" value="10" style="flex:0 0 34%;padding:8px;border-radius:8px;background:#08151b;border:1px solid rgba(255,255,255,0.03);color:#dff7f3"/>
                    <button class="btn" id="betBtn">Ставка</button>
                    <button class="btn ghost" id="cashOutBtn">Забрать</button>
                </div>
            </div>
        </div>

        <!-- Cases -->
        <div class="card" id="casesView" style="display:none">
            <div class="small">Открой кейс и получи подарок</div>
            <div class="cases-grid" style="margin-top:10px">
                <div class="case">
                    <div style="font-weight:700">Starter</div>
                    <div class="price">10</div>
                    <div class="open" data-cost="10">Открыть</div>
                </div>
                <div class="case">
                    <div style="font-weight:700">Pro</div>
                    <div class="price">50</div>
                    <div class="open" data-cost="50">Открыть</div>
                </div>
                <div class="case">
                    <div style="font-weight:700">VIP</div>
                    <div class="price">200</div>
                    <div class="open" data-cost="200">Открыть</div>
                </div>
                <div class="case">
                    <div style="font-weight:700">Legend</div>
                    <div class="price">1000</div>
                    <div class="open" data-cost="1000">Открыть</div>
                </div>
            </div>
        </div>

        <!-- Upgrade -->
        <div class="card" id="upgradeView" style="display:none">
            <div class="small">Апгрейдни подарок: шанс выиграть умножение</div>
            <div class="upgrade-list" style="margin-top:10px">
                <div class="upgrade-item">
                    <div>
                        <div style="font-weight:700">x2 — 50% шанс</div>
                        <div class="small">примерный доход: 2x</div>
                    </div>
                    <button class="btn ghost" data-mult="2">Играть</button>
                </div>
                <div class="upgrade-item">
                    <div>
                        <div style="font-weight:700">x5 — 20% шанс</div>
                        <div class="small">примерный доход: 5x</div>
                    </div>
                    <button class="btn ghost" data-mult="5">Играть</button>
                </div>
                <div class="upgrade-item">
                    <div>
                        <div style="font-weight:700">x10 — 10% шанс</div>
                        <div class="small">примерный доход: 10x</div>
                    </div>
                    <button class="btn ghost" data-mult="10">Играть</button>
                </div>
            </div>
        </div>
    </div>

    <footer>GiftKick • MVP</footer>
</div>

<!-- Modal -->
<div class="modal" id="modal">
    <div class="panel">
        <div id="modalTitle" style="font-weight:700;margin-bottom:8px">Модалка</div>
        <div id="modalBody" class="small" style="margin-bottom:12px">Контент</div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="modalClose">Закрыть</button>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand?.();

    // Basic state
    let user = {id:null, name:'Игрок'};
    let balance = 1000.0; // demo balance
    const elBalance = document.getElementById('balanceVal');
    const elUser = document.getElementById('userName');

    // init from Telegram (if available)
    try{
      const init = tg.initDataUnsafe || {};
      if(init.user){
        user.id = init.user.id;
        user.name = init.user.first_name || init.user.username || 'Игрок';
      }
    }catch(e){ /* ignore */ }

    function refreshUI(){
      elBalance.textContent = (balance).toFixed(2);
      elUser.textContent = user.name;
    }
    refreshUI();

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const target = t.dataset.tab;
        document.getElementById('rocketView').style.display = target==='rocket'?'block':'none';
        document.getElementById('casesView').style.display = target==='cases'?'block':'none';
        document.getElementById('upgradeView').style.display = target==='upgrade'?'block':'none';
      })
    });

    /* ---------- Rocket (Crash) logic - demo client-only ---------- */
    let rocketRound = null;
    const multiplierEl = document.getElementById('multiplier');
    const fillEl = document.getElementById('rocketFill');
    const statusEl = document.getElementById('rocketStatus');
    const betInput = document.getElementById('betInput');
    const betBtn = document.getElementById('betBtn');
    const cashOutBtn = document.getElementById('cashOutBtn');

    let playerBet = 0;
    let playerActive = false;
    let playerCashoutMultiplier = 1.0;

    function startRoundDemo(){
      // demo: generate random crash multiplier between 1.0 and 12.0
      const crashAt = (Math.random()*11 + 1).toFixed(2) * 1;
      let t = 0;
      let mult = 1.00;
      playerActive = false;
      playerBet = 0;
      playerCashoutMultiplier = 1.0;
      multiplierEl.textContent = 'x1.00';
      statusEl.textContent = 'Раунд начался';
      fillEl.style.width = '0%';

      rocketRound = setInterval(()=>{
        t += 0.05;
        // ease out exponential growth for multiplier
        mult = Math.min(crashAt, (1 + Math.pow(1.02, t)));
        multiplierEl.textContent = 'x' + mult.toFixed(2);
        // visual fill (map multiplier to percent for demo)
        const pct = Math.min(100, (Math.log(mult+1)/Math.log(13)) * 100);
        fillEl.style.width = pct + '%';

        // if player has cashed out earlier, do nothing (we still render)
        if(mult >= crashAt - 0.001){
          // crash!
          clearInterval(rocketRound);
          statusEl.textContent = 'Краш! Множитель упал до x' + crashAt.toFixed(2);
          // check player
          if(playerActive && playerCashoutMultiplier < crashAt){
            // already cashed out earlier -> succes
          } else if(playerActive && playerCashoutMultiplier >= crashAt){
            // cashed out after crash - invalid
          } else {
            // if player still active -> lost stake
            // playerBet is lost
            playerActive = false;
            playerBet = 0;
            // update UI
            refreshUI();
          }
          // start next round in 4s
          setTimeout(startRoundDemo, 4000);
        }
      }, 60);
    }

    betBtn.addEventListener('click', ()=>{
      const v = parseFloat(betInput.value);
      if(isNaN(v)||v<=0){ alert('Введите ставку'); return; }
      if(v>balance){ alert('Недостаточно средств'); return; }
      // place bet (client demo)
      playerBet = v;
      playerActive = true;
      balance -= v;
      refreshUI();
      statusEl.textContent = 'Ставка сделана: '+v;
    });

    cashOutBtn.addEventListener('click', ()=>{
      if(!playerActive || playerBet<=0){ alert('Нет активной ставки'); return; }
      const curMult = parseFloat(multiplierEl.textContent.replace('x','')) || 1;
      // cashout logic (demo)
      const win = playerBet * curMult;
      balance += win;
      playerActive = false;
      playerBet = 0;
      playerCashoutMultiplier = curMult;
      statusEl.textContent = 'Вы забрали x' + curMult.toFixed(2) + ' = ' + win.toFixed(2);
      refreshUI();
    });

    // start first demo round
    startRoundDemo();

    /* ---------- Cases (demo) ---------- */
    document.querySelectorAll('.case .open').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const cost = parseFloat(btn.dataset.cost);
        if(cost>balance){ alert('Недостаточно средств'); return; }
        // simulate server call
        balance -= cost;
        refreshUI();
        btn.textContent = 'Открывается...';
        await new Promise(r=>setTimeout(r, 900));
        // demo rarity
        const r = Math.random();
        let prizeText='Обычный подарок';
        if(r>0.95){ prizeText='Супер редкий подарок'; balance += cost*8; } // payout demo
        else if(r>0.7){ prizeText='Редкий подарок'; balance += cost*2; }
        else { prizeText='Обычный подарок'; /* maybe small return */ }
        btn.textContent = 'Открыть';
        showModal('Результат', prizeText);
        refreshUI();
        // TODO: send result to backend, mint gift, etc.
      });
    });

    /* ---------- Upgrades (demo) ---------- */
    document.querySelectorAll('[data-mult]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const mult = parseFloat(b.dataset.mult);
        // ask user stake amount
        const stake = prompt('Введите сумму (баланс: '+balance.toFixed(2)+')','10');
        const s = parseFloat(stake);
        if(isNaN(s)||s<=0 || s>balance){ alert('Неверная сумма'); return; }
        // simulate chance
        const probs = {2:0.5,5:0.2,10:0.1};
        const p = probs[mult] || 0.1;
        balance -= s;
        refreshUI();
        const won = Math.random() < p;
        setTimeout(()=>{
          if(won){
            const gain = s * mult;
            balance += gain;
            showModal('Успех', 'Вы выиграли: ' + gain.toFixed(2));
          } else {
            showModal('Проигрыш', 'К сожалению, вы потеряли ставку');
          }
          refreshUI();
        },800);
      });
    });

    /* ---------- Modal utilities ---------- */
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    document.getElementById('modalClose').onclick = ()=>{ modal.classList.remove('open') }
    function showModal(title,body){
      modalTitle.textContent = title;
      modalBody.textContent = body;
      modal.classList.add('open');
    }

    /* ---------- Placeholder: calls to backend ---------- */
    async function apiCall(path, data){
      // TODO: implement real server calls
      // return fetch(`/api/${path}`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(data)}).then(r=>r.json())
      return {ok:true};
    }

    /* ---------- Send data to bot (optional) ---------- */
    function sendToBot(msg){
      tg.sendData(JSON.stringify(msg));
    }

    // optional: when closing miniapp, you can pass state to bot
    // tg.onEvent('backButtonClicked', ()=>{ sendToBot({action:'leave'}); });

</script>
</body>
</html>
